<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
  <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
  <title>Places of origin for programming languages</title>
  <style>
    html, body { height: auto; }
    p { margin: 0.75em 0; }
    #map_element { position: absolute; bottom: 0; left: 0; right: 0; top: 0; }
    .parameters div { margin-bottom: 0.5em; }
  </style>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>

<body>
  <div id="map_element"></div>
  <script>
    // Using library 'oms' to split markers at the same locations: https://github.com/jawj/OverlappingMarkerSpiderfier
    var mapLibsReady = 0;
    var geocoder;
    var map;

    var icons = {
                  default:"http://ok.denis-shirshov.ru/_resources/img/gmm/computer.png",
                  brown: "http://ok.denis-shirshov.ru/_resources/img/gmm/brown_MarkerL.png",
                  red: "http://ok.denis-shirshov.ru/_resources/img/gmm/red_MarkerL.png",
                  orange: "http://ok.denis-shirshov.ru/_resources/img/gmm/orange_MarkerL.png",
                  yellow: "http://ok.denis-shirshov.ru/_resources/img/gmm/yellow_MarkerL.png",
                  green: "http://ok.denis-shirshov.ru/_resources/img/gmm/green_MarkerL.png",
                  paleblue: "http://ok.denis-shirshov.ru/_resources/img/gmm/paleblue_MarkerL.png",
                  blue: "http://ok.denis-shirshov.ru/_resources/img/gmm/blue_MarkerL.png",
                  purple: "http://ok.denis-shirshov.ru/_resources/img/gmm/purple_MarkerL.png",
                  pink: "http://ok.denis-shirshov.ru/_resources/img/gmm/pink_MarkerL.png",
                };

    function in_interval(val, left, right) {
      return val >= left && val < right;
    }

    function initialize() {
      var map = new google.maps.Map(
        document.getElementById("map_canvas"), {
          mapTypeId: google.maps.MapTypeId.ROADMAP
        });
      var layer = new google.maps.KmlLayer({
        // url: "http://www.google.com/maps/d/kml?mid=zNPjLbo835mE.k3TvWfqGG-AU",
        // load map with my access key:
        url: "http://www.google.com/maps/d/kml?mid=1PywCAj-xMr2JF4SKG86-2u1LRHneMDA5",
        map: map
      })
    }

    function mapLibReadyHandler() {
      $(document).ready(function() {
        $.ajax({
            type: "GET",
            url: "data/programming-languages-locations.csv",
            dataType: "text",
            success: function(data) {processData(data);}
            });
      })
    }

    function processData(data) {
      if (++ mapLibsReady < 2) return;
      var mapElement = document.getElementById('map_element');
      var map = new google.maps.Map(mapElement, { center: { lat: 23, lng: 23 }, zoom:3 });
      var iw = new google.maps.InfoWindow();
      var oms = new OverlappingMarkerSpiderfier(map, {
        markersWontMove: true,   // we promise not to move any markers, allowing optimizations
        markersWontHide: true,   // we promise not to change visibility of any markers, allowing optimizations
        basicFormatEvents: true  // allow the library to skip calculating advanced formatting information
      });

      var data = csv_to_json(data, ",");
      var geojson_data = GeoJSON.parse(data, {Point: ["lat", "lon"]});
      window.data = data;
      window.mapData = geojson_data;
      console.log(window.mapData);

      for (var i = 0, len = window.mapData.features.length; i < len; i ++) {
        (function() {  // make a closure over the marker and marker data
          var lat = parseFloat(window.data[i].lat);
          var lon = parseFloat(window.data[i].lon);
          var markerData = window.data[i];  // e.g. { lat: 50.123, lng: 0.123, text: 'XYZ' }
          markerData.lat = lat;
          markerData.lng = lon;
          var year = parseInt(window.data[i].year);
          var image = "";
          if (year < 1950) {
            image =  icons.brown;
          }
          else if (in_interval(year, 1950, 1960)) {
            image =  icons.red;
          }
          else if (in_interval(year, 1960, 1970)) {
            image =  icons.orange;
          }
          else if (in_interval(year, 1970, 1980)) {
            image =  icons.yellow;
          }
          else if (in_interval(year, 1980, 1990)) {
            image =  icons.green;
          }
          else if (in_interval(year, 1990, 2000)) {
            image =  icons.paleblue;
          }
          else if (in_interval(year, 2000, 2010)) {
            image =  icons.purple;
          }
          else if (in_interval(year, 2010, 2020)) {
            image =  icons.pink;
          }
          else {
            image = icons.default;
          }
          // console.log(markerData);
          var marker = new google.maps.Marker({ position: markerData, icon: image });  // markerData works here as a LatLngLiteral
          var content = `<h3>${markerData.language}</h3>
                        <div class='parameters'>
                        <div>City: <b>${markerData.town}</b></div>
                        <div>Year: <b>${markerData.year}</b></p>
                        </div>`;
          google.maps.event.addListener(marker, 'spider_click', function(e) {  // 'spider_click', not plain 'click'
            iw.setContent(content);
            iw.open(map, marker);
          });
          oms.addMarker(marker);  // adds the marker to the spiderfier _and_ the map
        })();
      }

      google.maps.event.addDomListener(window, "load", initialize);
    }


  </script>

  <script async defer src="https://maps.google.com/maps/api/js?v=3&callback=mapLibReadyHandler&key=AIzaSyDx01RkpEkH1GST5fgFUC3VslWty7Xc4ac"></script>
  <script async defer src="http://ok.denis-shirshov.ru/_resources/lib/oms.min.js?spiderfier_callback=mapLibReadyHandler"></script>
  <script src="http://ok.denis-shirshov.ru/_resources/lib/geojson.min.js"></script>
  <script src="http://ok.denis-shirshov.ru/_resources/lib/CsvToJson.js"></script>
</body>
</html>
